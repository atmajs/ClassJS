(function(t,n){null==t&&(t="undefined"!=typeof window&&"undefined"!=typeof document?window:global),t.Class=n(t)})(this,function(){"use strict";function t(t,n){if(t instanceof Array)for(var r=0,e=t.length;e>r;r++)n(t[r],r);else n(t)}function n(t){"function"==typeof t&&(t=t.prototype);for(var n,r,e=1,i=arguments.length;i>e;e++){n="function"==typeof arguments[e]?arguments[e].prototype:arguments[e];for(r in n)if("Static"!==r||null==t.Static)t[r]=n[r];else for(r in t.Static)t.Static[r]=t.Static[r]}return t}function r(t){if(null!=t&&"object"==typeof t)for(var n in t)null!=t[n]&&(this[n]=t[n])}var e=Array.prototype.slice,i=Array.prototype.sort;"function"!=typeof Array.isArray&&(Array.isArray=function(t){return t instanceof Array?!0:null==t||"object"!=typeof t?!1:void 0!==t.length&&"function"==typeof t.slice});var o=function(){function n(t,n){if(null!=n){"function"==typeof t&&(t=t.prototype),"function"==typeof n&&(n=n.prototype);for(var r in n)t[r]=n[r]}}function r(t,n,r){var e=t[n],i=function(t){return u(t)?e.apply(this,t):e.apply(this,arguments)};return function(){return this.super=i,r.apply(this,arguments)}}function e(e,i,s,u,l){var h=u,c=u;if(h.constructor=e.prototype.constructor,null!=s&&(c[o]={},t(s,function(t){n(c[o],t)}),c=c[o]),null!=i&&(c[o]=i.prototype),null!=l)for(var a in l)h[a]=r(h,a,l[a]);e.prototype=h}function i(r,e,i,o){if(null!=e){var s=function(){};s.prototype=e.prototype,r.prototype=new s,r.prototype.constructor=r}n(r.prototype,o),null!=i&&t(i,function(t){var e={};n(e,t),delete e.constructor;for(var i in e)r.prototype[i]=e[i]})}var o="__proto__",s=Object.prototype.toString,u=function(t){return"[object Arguments]"===s.call(t)};return"__proto__"in Object.prototype==!0?e:i}(),s=function(t,n){if(null!=n)if("function"!=typeof n)if(Array.isArray(n))for(var r=n.length,e=0;0!==r--;)s(t,n[e++]);else if(n.Static){n=n.Static;for(var i in n)n.hasOwnProperty(i)&&null==t[i]&&(t[i]=n[i])}else;else for(var i in n)"function"==typeof n[i]&&n.hasOwnProperty(i)&&null==t[i]&&(t[i]=n[i])},u={toJSON:function(){var t,n,r={};for(t in this)95!==t.charCodeAt(0)&&"Static"!==t&&(n=this[t],null!=n&&"function"!=typeof n&&(r[t]=n));return r}},l={};t(["get","del"],function(t){l[t]=function(n,r){this.promise[t](n).then(function(t,n){return t?(r.onError(t,n),void 0):(r.onSuccess(n),void 0)})}}),t(["post","put"],function(t){l[t]=function(n,r,e){this.promise[t](n,r).then(function(t,n){e(t,n)})}}),function(t){function n(t,n){return function(){return t.apply(n,arguments)}}function r(){this._callbacks=[]}function e(t){function n(t){return function(n,r){i+=1,s[t]=n,u[t]=r,i===e&&o.done(s,u)}}for(var e=t.length,i=0,o=new r,s=[],u=[],l=0;e>l;l++)t[l]().then(n(l));return o}function i(t,n,e){var o=new r;return 0===t.length?o.done(n,e):t[0](n,e).then(function(n,r){t.splice(0,1),i(t,n,r).then(function(t,n){o.done(t,n)})}),o}function o(t){var n="";if("string"==typeof t)n=t;else{var r=encodeURIComponent;for(var e in t)t.hasOwnProperty(e)&&(n+="&"+r(e)+"="+r(t[e]))}return n}function s(){var t;if(window.XMLHttpRequest)t=new XMLHttpRequest;else if(window.ActiveXObject)try{t=new ActiveXObject("Msxml2.XMLHTTP")}catch(n){t=new ActiveXObject("Microsoft.XMLHTTP")}return t}function u(n,e,i,u){function l(){h.abort(),a.done(t.promise.ETIMEOUT,"")}var h,c,a=new r;i=i||{},u=u||{};try{h=s()}catch(f){return a.done(-1,""),a}c=o(i),"GET"===n&&c&&(e+="?"+c,c=null),h.open(n,e),h.setRequestHeader("Content-type","application/x-www-form-urlencoded");for(var p in u)u.hasOwnProperty(p)&&h.setRequestHeader(p,u[p]);var y=t.promise.ajaxTimeout;if(y)var v=setTimeout(l,y);return h.onreadystatechange=function(){y&&clearTimeout(v),4===h.readyState&&(200===h.status?a.done(null,h.responseText):a.done(h.status,h.responseText))},h.send(c),a}function l(t){return function(n,r,e){return u(t,n,r,e)}}r.prototype.then=function(t,r){var e=n(t,r);this._isdone?e(this.error,this.result):this._callbacks.push(e)},r.prototype.done=function(t,n){this._isdone=!0,this.error=t,this.result=n;for(var r=0;this._callbacks.length>r;r++)this._callbacks[r](t,n);this._callbacks=[]};var h={Promise:r,join:e,chain:i,ajax:u,get:l("GET"),post:l("POST"),put:l("PUT"),del:l("DELETE"),ENOXHR:1,ETIMEOUT:2,ajaxTimeout:0};"function"==typeof define&&define.amd?define(function(){return h}):t.promise=h}(l),r.prototype={constructor:r,serialize:function(){return JSON.stringify(this)},deserialize:function(t){"string"==typeof t&&(t=JSON.parse(t));for(var n in t)this[n]=t[n];return this}};var h=function(){function t(t){this.route=e(t)}function n(t){var n=o.exec(t);return n?{optional:"?"===(n[2]||n[3]),parts:[n[1],n[4]]}:(n=s.exec(t))?{optional:"?"===n[3],parts:[n[1],n[4],n[5]]}:(console.error("Paths breadcrumbs should be match by regexps"),{parts:[t]})}function r(t,r){for(var e=t.split(r),i=0,o=e.length;o>i;i++)e[i]=n(e[i]);return e}function e(t){var n=/[^\:\{]\?[^:]/.exec(t),e=null;return n&&(n=n.index+1,e=t.substring(n+1),t=t.substring(0,n)),{path:r(t,"/"),query:null==e?null:r(e,"&")}}function i(t,n,r){for(var e,i,o,s=[],u=0,l=t.length;l>u;u++)if(o=t[u],i=o.parts.slice(0),null!=i[1]){if(e=i[1],i[1]=n[e],null!=i[1])s.push(i.join(""));else if(!o.optional)return console.error("Object has no value, for not optional part - ",e),null}else s.push(i[0]);return s.join(r)}t.prototype={constructor:t,create:function(t){var n,r;return n=i(this.route.path,t,"/"),null==n?null:this.route.query&&(r=i(this.route.query,t,"&"),null==r)?null:n+(r?"?"+r:"")}};var o=/^([^:\?]*)(\??):(\??)([\w]+)$/,s=/^([^\{\?]*)(\{(\??)([\w]+)\})?([^\s]*)?$/;return t}(),c={_isAsync:!0,_done:null,_fail:null,_always:null,_resolved:!1,_rejected:!1,deferr:function(){this._rejected=!1,this._resolved=!1},resolve:function(){this._fail=null,this._resolved=arguments;var t=this._done,n=t&&t.length,r=0;if(t){for(;0!==n--;)t[r++].apply(this,arguments);this._done=null}if(t=this._always,n=t&&t.length,r=0,t){for(;0!==n--;)t[r++].apply(this,this);this._always=null}return this},reject:function(){this._done=null,this._rejected=arguments;var t=this._fail,n=t&&t.length,r=0;if(t){for(;0!==n--;)t[r++].apply(this,arguments);this._fail=null}if(t=this._always,n=t&&t.length,r=0,t){for(;0!==n--;)t[r++].apply(this,this);this._always=null}return this},done:function(t){return this._resolved?t.apply(this,this._resolved):(this._done||(this._done=[])).push(t),this},fail:function(t){return this._rejected?t.apply(this,this._rejected):(this._fail||(this._fail=[])).push(t),this},always:function(t){return this._rejected||this._resolved?t.apply(this,this):(this._always||(this._always=[])).push(t),this}},a=function(){function t(){this._listeners={}}return t.prototype={constructor:t,on:function(t,n){return(this._listeners[t]||(this._listeners[t]=[])).push(n),this},once:function(t,n){return n._once=!0,(this._listeners[t]||(this._listeners[t]=[])).push(n),this},pipe:function(t){var n,r=this,e=Array.prototype.slice;return function(){n=e.call(arguments),n.unshift(t),r.trigger.apply(r,n)}},trigger:function(){var t,n,r=Array.prototype.slice.call(arguments),e=r.shift(),i=this._listeners[e],o=0;if(null==i)return this;for(n=i.length;n>o;o++)t=i[o],t.apply(this,r),t._once===!0&&(i.splice(o,1),o--,length--);return this},off:function(t,n){if(null==this._listeners[t])return this;for(var r=this._listeners[t],e=r.length,i=0;e>i;i++)r[i]===n&&r.splice(i,1),i--,length--;return this}},t}(),f=function(){function t(t,n){return n instanceof t?n:new t(n)}function r(t,n){return function(){return this.length=0,this._constructor=n,null!=t?t.apply(this,arguments):this}}function o(t,e){return e.Construct=r(e.Construct,t),n(e,u,s),g(e)}var s=function(){function n(t,n){if(null==n)return!1;if("function"==typeof n)return n(t);if("object"==typeof n){var r,e;for(var i in n){if(r=t[i],e=n[i],"string"==typeof e){var o=e[0],s=1;if("<"===o||">"===o)switch("="===e[1]&&(o+="=",s++),e=e.substring(s),o){case"<":if(r>=e)return!1;continue;case"<=":if(r>e)return!1;continue;case">":if(e>=r)return!1;continue;case">=":if(e>r)return!1;continue}}if(r!=e)return!1}return!0}return console.warn("No valid matcher",n),!1}var r={push:function(){for(var n=0,r=arguments.length;r>n;n++)this[this.length++]=t(this._constructor,arguments[n]);return this},pop:function(){var t=this[--this.length];return this[this.length]=null,t},shift:function(){if(0===this.length)return null;for(var t=this[0],n=this.length-1,r=0;n>r;r++)this[r]=this[r+1];return this[n]=null,this.length--,t},unshift:function(n){this.length++;for(var r=this.length;--r;)this[r]=this[r-1];this[0]=t(this._constructor,n)},splice:function(n,r){var e,i,o;if(n>=this.length)for(r=0,e=this.length,i=n;i>e;e++)this[e]=void 0;var s=r,u=n,l=n+s,h=arguments.length-2,c=this.length+h-s,a=l,f=this.length,p=c-this.length;if(p>0)for(e=f;--e>=a;)this[e+p]=this[e];if(0>p)for(e=a;f>e;)this[e+p]=this[e],e++;for(e=u,o=2;arguments.length>o;o)this[e++]=t(this._constructor,arguments[o++]);return this.length=c,this},slice:function(){return e.apply(this,arguments)},sort:function(t){return i.call(this,t),this},reverse:function(){for(var t=e.call(this,0),n=0,r=this.length;r>n;n++)this[n]=t[r-n-1]},toString:function(){return""+e.call(this,0)},each:function(t,n){for(var r=0,e=this.length;e>r;r++)t.call(n||this,this[r],r)},where:function(t){for(var r,e=new this.constructor,i=0,o=this.length;o>i;i++)r=this[i],n(r,t)&&(e[e.length++]=r);return e},remove:function(t){for(var r=-1,e=[],i=0,o=this.length;o>i;i++)n(this[i],t)?e.push(this[i]):this[++r]=this[i];for(i=++r;o>i;i++)this[i]=null;return this.length=r,e},first:function(t){if(null==t)return this[0];for(var r=this.length,e=0;-1!==--r;)if(n(this[e++],t))return this[e-1];return null},last:function(t){if(null==t)return this[0];for(var r=this.length;-1!==--r;)if(n(this[r],t))return this[r];return null}};return r}(),u={serialize:function(){return JSON.stringify(this.toArray())},deserialize:function(n){for(var r=0,e=n.length;e>r;r++)this[this.length++]=t(this._constructor,n[r]);return this},del:function(t){if(null==t){for(var n=0,r=this.length;r>n;n++)this[n]=null;return this.length=0,v.prototype.del.call(this),this}var e=this.remove(t);return 0===e.length?this:this.save()},toArray:function(){for(var t=Array(this.length),n=0,r=this.length;r>n;n++)t[n]=this[n];return t}};return o}(),p={deserialize:function(t){"string"==typeof t&&(t=JSON.parse(t));for(var n in t)this[n]=t[n];return this},serialize:function(){return JSON.stringify(this)},fetch:null,save:null,del:null,onSuccess:null,onError:null,Static:{fetch:function(t){return(new this).fetch(t)}}},y=function(){var t=function(t){this._route=new h(t)};return n(t,p,c,{fetch:function(t){return l.get(this._route.create(t||this),this),this},save:function(t){l.post(this._route.create(this),this.serialize(),t)},del:function(t){l.del(this._route.create(this),this.serialize(),t)},onSuccess:function(t){var n;try{n=JSON.parse(t)}catch(r){return this.onError(r),void 0}this.deserialize(n),this.resolve(this)},onError:function(t){this.reject({error:t})}}),function(n){return new t(n)}}(),v=function(){var t=function(t){this._route=new h(t)};n(t,p,c,{fetch:function(t){var n=this._route.create(t||this),r=localStorage.getItem(n);if(null==r)return this.resolve(this),this;if("string"==typeof r)try{r=JSON.parse(r)}catch(e){this.onError(e)}return this.deserialize(r),this.resolve(this)},save:function(t){var n=this._route.create(this),r=this.serialize();return localStorage.setItem(n,r),t&&t(),this},del:function(t){var n=this._route.create(t||this);return localStorage.removeItem(n),this},onError:function(t){this.reject({error:t})}});var r=function(n){return new t(n)};return r.prototype=t.prototype,r}(),g=function(t){var n,r=t.Base,e=t.Extends,i=t.Static,l=t.Construct,h=null,c=t.Store,a=t.Override;if(null!=r&&delete t.Base,null!=e&&delete t.Extends,null!=i&&delete t.Static,null!=l&&delete t.Construct,null!=c&&(null==e?e=c:Array.isArray(e)?e.push(c):e=[e,c],delete t.Store),null!=a&&delete t.Override,void 0===t.toJSON&&(t.toJSON=u.toJSON),null==r&&null==e){if(h=null==l?function(){}:l,t.constructor=h.prototype.constructor,null!=i)for(n in i)h[n]=i[n];return h.prototype=t,h}if(h=function(){if(null!=e)for(var t=e instanceof Array,n=t?e.length:1,i=null,o=0;t?n>o:1>o;o++)i=t?e[o]:e,"function"==typeof i&&i.apply(this,arguments);if(null!=r&&r.apply(this,arguments),null!=l){var s=l.apply(this,arguments);if(null!=s)return s}return this},null!=i)for(n in i)h[n]=i[n];return null!=r&&s(h,r),null!=e&&s(h,e),o(h,r,e,t,a),t=null,i=null,h};return g.bind=function(t){for(var n,r=arguments,e=1,i=arguments.length;i>e;e++)n=r[e],t[n]=t[n].bind(t);return t},g.Remote=y,g.LocalStore=v,g.Collection=f,g.Serializable=r,g.Deferred=c,g.EventEmitter=a,g});