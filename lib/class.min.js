(function(t,n){"use strict";var r,e,i=!1;"undefined"==typeof exports||null!=t&&t!==exports&&t!==global||(r=global,i=!0),null==r&&(r="undefined"==typeof window?global:window),null==e&&(e=t||r),n(r,e),i&&(module.exports=e.Class)})(this,function(t,n){"use strict";function r(t){return"function"==typeof t}function e(t){return null!=t&&"number"==typeof t.length&&"function"==typeof t.slice}function i(t){return"string"==typeof t}function u(t,n){if(o(t))for(var r=0,e=t.length;e>r;r++)n(t[r],r);else n(t)}function o(t){return null!=t&&"object"==typeof t&&"number"==typeof t.length&&"function"==typeof t.splice}function s(t){return"function"==typeof t?t.prototype:t}function l(t,n,r){var e,i;for(e in t)i=t[e],c(i)&&(null!=n&&c(n.prototype[e])&&f(i,n.prototype[e]),null!=r&&u(r,function(t){t=s(t),c(t[e])&&f(i,t[e])}))}function a(t){"function"==typeof t&&(t=t.prototype);for(var n,r,e=1,i=arguments.length;i>e;e++){n="function"==typeof arguments[e]?arguments[e].prototype:arguments[e];for(r in n)if("Static"!==r||null==t.Static)t[r]=n[r];else for(r in t.Static)t.Static[r]=t.Static[r]}return t}function h(t,n){if("object"!=typeof t||null==n)return t;for(var r,e=t,i=n.split("."),u=i.length,o=0;u>o;o++)if(r=i[o],e=e[r],null==e)return e;return e}function c(t){return null==t?!1:"object"!=typeof t?!1:t.constructor===Object}function f(t,n){for(var r in n)null==t[r]&&(t[r]=n[r]);return t}function p(t,n){for(var r in n)n[r]&&(t[r]=n[r]);return t}function g(t,n){return function(){switch(arguments.length){case 1:return t.call(n,arguments[0]);case 2:return t.call(n,arguments[0],arguments[1]);case 3:return t.call(n,arguments[0],arguments[1],arguments[2]);case 4:return t.call(n,arguments[0],arguments[1],arguments[2],arguments[3]);case 5:return t.call(n,arguments[0],arguments[1],arguments[2],arguments[3],arguments[4])}return t.apply(n,arguments)}}function v(n){if(this===N||null==this||this===t){var r=function(t){v.call(this,t)};return r.prototype._props=n,p(r.prototype,v.prototype),r}null!=n&&this.deserialize(n)}function y(){}var d=Array.prototype.slice,m=Array.prototype.sort;"function"!=typeof Array.isArray&&(Array.isArray=function(t){return t instanceof Array?!0:null==t||"object"!=typeof t?!1:void 0!==t.length&&"function"==typeof t.slice});var _=function(){function t(t,n){if(null!=n){"function"==typeof t&&(t=t.prototype),"function"==typeof n&&(n=n.prototype);for(var r in n)t[r]=n[r]}}function n(t,n,r){var e=t[n],i=null==e?function(){}:function(t){return s(t)?e.apply(this,t):e.apply(this,arguments)};return function(){return this["super"]=i,r.apply(this,arguments)}}function r(r,e,o,s,l){var a=s,h=s;if(a.constructor=r.prototype.constructor,null!=o&&(h[i]={},u(o,function(n){t(h[i],n)}),h=h[i]),null!=e&&(h[i]=e.prototype),null!=l)for(var c in l)a[c]=n(a,c,l[c]);r.prototype=a}function e(n,r,e,i){if(null!=r){var o=function(){};o.prototype=r.prototype,n.prototype=new o,n.prototype.constructor=n}null!=e&&u(e,function(r){delete r.constructor,t(n,r)}),t(n,i)}var i="__proto__",o=Object.prototype.toString,s=function(t){return"[object Arguments]"===o.call(t)};return"__proto__"in Object.prototype==!0?r:e}(),S=function(t,n){if(null!=n)if("function"!=typeof n){if(Array.isArray(n))for(var r=n.length,e=0;0!==r--;)S(t,n[e++]);else if(n.Static){n=n.Static;for(var i in n)n.hasOwnProperty(i)&&null==t[i]&&(t[i]=n[i])}}else for(var i in n)"function"==typeof n[i]&&n.hasOwnProperty(i)&&null==t[i]&&(t[i]=n[i])},w={toJSON:function(){var t,n,r={};for(t in this)(95!==t.charCodeAt(0)||"_id"===t)&&"Static"!==t&&"Validate"!==t&&(n=this[t],null!=n&&"function"!=typeof n&&(r[t]=n));return r},arrayToJSON:function(){for(var t,n=Array(this.length),e=0,i=this.length;i>e;e++){if(t=this[e],"object"!=typeof t)return n[e]=t,void 0;n[e]=r(t.toJSON)?t.toJSON():w.toJSON.call(t)}return n}},O={};u(["get"],function(t){O[t]=function(n,r){this.promise[t](n).then(function(t,n){return t?(r.onError(t,n),void 0):(r.onSuccess(n),void 0)})}}),u(["del","post","put"],function(t){O[t]=function(n,r,e){this.promise[t](n,r).then(function(t,n){e(t,n)})}}),function(t){function n(t,n){return function(){return t.apply(n,arguments)}}function r(){this._callbacks=[]}function e(t){function n(t){return function(n,r){i+=1,o[t]=n,s[t]=r,i===e&&u.done(o,s)}}for(var e=t.length,i=0,u=new r,o=[],s=[],l=0;e>l;l++)t[l]().then(n(l));return u}function i(t,n,e){var u=new r;return 0===t.length?u.done(n,e):t[0](n,e).then(function(n,r){t.splice(0,1),i(t,n,r).then(function(t,n){u.done(t,n)})}),u}function u(t){var n="";if("string"==typeof t)n=t;else{var r=encodeURIComponent;for(var e in t)t.hasOwnProperty(e)&&(n+="&"+r(e)+"="+r(t[e]))}return n}function o(){var t;if(window.XMLHttpRequest)t=new XMLHttpRequest;else if(window.ActiveXObject)try{t=new ActiveXObject("Msxml2.XMLHTTP")}catch(n){t=new ActiveXObject("Microsoft.XMLHTTP")}return t}function s(n,e,i,s){function l(){a.abort(),c.done(t.promise.ETIMEOUT,"")}var a,h,c=new r;i=i||{},s=s||{};try{a=o()}catch(f){return c.done(-1,""),c}h=u(i),"GET"===n&&h&&(e+="?"+h,h=null),a.open(n,e),a.setRequestHeader("Content-type","application/x-www-form-urlencoded");for(var p in s)s.hasOwnProperty(p)&&a.setRequestHeader(p,s[p]);var g=t.promise.ajaxTimeout;if(g)var v=setTimeout(l,g);return a.onreadystatechange=function(){g&&clearTimeout(v),4===a.readyState&&(200===a.status?c.done(null,a.responseText):c.done(a.status,a.responseText))},a.send(h),c}function l(t){return function(n,r,e){return s(t,n,r,e)}}r.prototype.then=function(t,r){var e=n(t,r);this._isdone?e(this.error,this.result):this._callbacks.push(e)},r.prototype.done=function(t,n){this._isdone=!0,this.error=t,this.result=n;for(var r=0;this._callbacks.length>r;r++)this._callbacks[r](t,n);this._callbacks=[]};var a={Promise:r,join:e,chain:i,ajax:s,get:l("GET"),post:l("POST"),put:l("PUT"),del:l("DELETE"),ENOXHR:1,ETIMEOUT:2,ajaxTimeout:0};"function"==typeof define&&define.amd?define(function(){return a}):t.promise=a}(O),v.prototype={constructor:v,serialize:function(){return JSON.stringify(this)},deserialize:function(t){if(i(t))try{t=JSON.parse(t)}catch(n){return console.error("<json:deserialize>",t),this}if(!e(t)||!r(this.push)){var u,o,s=this._props;for(u in t){if(null!=s&&(o=s[u],null!=o)){if(r(o)){this[u]=new o(t[u]);continue}var l=o.deserialize;if(r(l)){this[u]=l(t[u]);continue}}this[u]=t[u]}return this}this.length=0;for(var a=0,h=t.length;h>a;a++)this.push(t[a])}};var b=function(){function t(t){this.route=e(t)}function n(t){var n=u.exec(t);return n?{optional:"?"===(n[2]||n[3]),parts:[n[1],n[4]]}:(n=o.exec(t))?{optional:"?"===n[3],parts:[n[1],n[4],n[5]]}:(console.error("Paths breadcrumbs should be matched by regexps"),{parts:[t]})}function r(t,r){for(var e=t.split(r),i=0,u=e.length;u>i;i++)e[i]=n(e[i]);return e}function e(t){var n=/[^\:\{]\?[^:]/.exec(t),e=null;return n&&(n=n.index+1,e=t.substring(n+1),t=t.substring(0,n)),{path:r(t,"/"),query:null==e?null:r(e,"&")}}function i(t,n,r){for(var e,i,u,o=[],s=0,l=t.length;l>s;s++)if(u=t[s],i=u.parts.slice(0),null!=i[1]){if(e=i[1],i[1]=n[e],null!=i[1])o.push(i.join(""));else if(!u.optional)return console.error("Object has no value, for not optional part - ",e),null}else o.push(i[0]);return o.join(r)}t.prototype={constructor:t,create:function(t){var n,r;return n=i(this.route.path,t,"/"),null==n?null:this.route.query&&(r=i(this.route.query,t,"&"),null==r)?null:n+(r?"?"+r:"")},hasAliases:function(t){for(var n,r=0,e=this.route.path.length;e>r;r++)if(n=this.route.path[r].parts[1],n&&null==t[n])return!1;return!0}};var u=/^([^:\?]*)(\??):(\??)([\w]+)$/,o=/^([^\{\?]*)(\{(\??)([\w]+)\})?([^\s]*)?$/;return t}();y.prototype={_isAsync:!0,_done:null,_fail:null,_always:null,_resolved:null,_rejected:null,deferr:function(){this._rejected=null,this._resolved=null},resolve:function(){this._fail=null,this._resolved=arguments;var t,n,r=this._done,e=this._always;if(this._done=null,this._always=null,null!=r){for(t=r.length,n=0;0!==t--;)r[n++].apply(this,arguments);r.length=0}if(null!=e)for(t=e.length,n=0;0!==t--;)e[n++].call(this,this);return this},reject:function(){this._done=null,this._rejected=arguments;var t,n,r=this._fail,e=this._always;if(this._fail=null,this._always=null,null!=r)for(t=r.length,n=0;0!==t--;)r[n++].apply(this,arguments);if(null!=e)for(t=e.length,n=0;0!==t--;)e[n++].call(this,this);return this},done:function(t){return null!=this._resolved?t.apply(this,this._resolved):(this._done||(this._done=[])).push(t),this},fail:function(t){return null!=this._rejected?t.apply(this,this._rejected):(this._fail||(this._fail=[])).push(t),this},always:function(t){return null!=this._rejected||null!=this._resolved?t.call(this,this):(this._always||(this._always=[])).push(t),this}};var j=function(){function t(){this._listeners={}}return t.prototype={constructor:t,on:function(t,n){return null!=n&&(this._listeners[t]||(this._listeners[t]=[])).push(n),this},once:function(t,n){return null!=n&&(n._once=!0,(this._listeners[t]||(this._listeners[t]=[])).push(n)),this},pipe:function(t){var n,r=this,e=Array.prototype.slice;return function(){n=e.call(arguments),n.unshift(t),r.trigger.apply(r,n)}},trigger:function(){var t,n,r=Array.prototype.slice.call(arguments),e=r.shift(),i=this._listeners[e],u=0;if(null==i)return this;for(n=i.length;n>u;u++)t=i[u],t.apply(this,r),t._once===!0&&(i.splice(u,1),u--,n--);return this},off:function(t,n){var r=this._listeners[t];if(null==r)return this;if(1===arguments.length)return r.length=0,this;for(var e=r.length,i=0;e>i;i++)r[i]===n&&r.splice(i,1),i--,e--;return this}},t}(),A=function(){function t(t,e,i){if(r(e))return e.call(t);var u,o;if(i){for(var s=0,l=i.length;l>s;s++)if(o=i[s],u=n(t,o,e[o]))return u}else for(o in e)if(u=n(t,o,e[o]))return u}function n(t,n,e){if(r(e)===!1)return"<validation> Function expected for "+n;var i=h(t,n);return e.call(t,i)}function e(n){var r,e;return arguments.length>1&&"string"==typeof arguments[1]&&(e=d.call(arguments,1)),null!=n.Validate&&(r=t(n,n.Validate,e))?r:void 0}return{validate:e}}(),N=function(t){var n,r=t.Base,i=t.Extends,u=t.Static,o=t.Construct,s=null,a=t.Store,h=t.Self,c=t.Override;if(null!=r&&delete t.Base,null!=i&&delete t.Extends,null!=u&&delete t.Static,null!=h&&delete t.Self,null!=o&&delete t.Construct,null!=a&&(null==i?i=a:e(i)?i.unshift(a):i=[a,i],delete t.Store),null!=c&&delete t.Override,void 0===t.toJSON&&(t.toJSON=w.toJSON),null==r&&null==i&&null==h){if(s=null==o?function(){}:o,t.constructor=s.prototype.constructor,null!=u)for(n in u)s[n]=u[n];return s.prototype=t,s}if(s=function(){if(null!=i)for(var t=i instanceof Array,n=t?i.length:1,e=null,u=0;t?n>u:1>u;u++)e=t?i[u]:i,"function"==typeof e&&e.apply(this,arguments);if(null!=r&&r.apply(this,arguments),null!=h)for(var s in h)this[s]=g(h[s],this);if(null!=o){var l=o.apply(this,arguments);if(null!=l)return l}return this},null!=u)for(n in u)s[n]=u[n];return null!=r&&S(s,r),null!=i&&S(s,i),l(t,r,i),_(s,r,i,t,c),t=null,u=null,s};N.bind=function(t){for(var n,r=arguments,e=1,i=arguments.length;i>e;e++)n=r[e],t[n]=t[n].bind(t);return t},N.Serializable=v,N.Deferred=y,N.EventEmitter=j,N.validate=A.validate,N.Collection=function(){function t(t,n){return n instanceof t?n:new t(n)}function n(t,n){return function(){return this.length=0,this._constructor=n,null!=t?t.apply(this,arguments):this}}function e(t,r){return r.Construct=n(r.Construct,t),a(r,u,i),N(r)}var i=function(){function n(t,n){if(null==n)return!1;if("function"==typeof n)return n(t);if("object"==typeof n){if(t.constructor===n.constructor&&t.constructor!==Object)return t===n;var r,e;for(var i in n){if(r=t[i],e=n[i],"string"==typeof e){var u=e[0],o=1;if("<"===u||">"===u)switch("="===e[1]&&(u+="=",o++),e=e.substring(o),u){case"<":if(r>=e)return!1;continue;case"<=":if(r>e)return!1;continue;case">":if(e>=r)return!1;continue;case">=":if(e>r)return!1;continue}}if(r!=e)return!1}return!0}return console.warn("No valid matcher",n),!1}var r={push:function(){for(var n=0,r=arguments.length;r>n;n++)this[this.length++]=t(this._constructor,arguments[n]);return this},pop:function(){var t=this[--this.length];return this[this.length]=null,t},shift:function(){if(0===this.length)return null;for(var t=this[0],n=this.length-1,r=0;n>r;r++)this[r]=this[r+1];return this[n]=null,this.length--,t},unshift:function(n){this.length++;for(var r=this.length;--r;)this[r]=this[r-1];return this[0]=t(this._constructor,n),this},splice:function(n,r){var e,i,u;if(n>=this.length)for(r=0,e=this.length,i=n;i>e;e++)this[e]=void 0;var o=r,s=n,l=n+o,a=arguments.length-2,h=this.length+a-o,c=l,f=this.length,p=h-this.length;if(p>0)for(e=f;--e>=c;)this[e+p]=this[e];if(0>p)for(e=c;f>e;)this[e+p]=this[e],e++;for(e=s,u=2;arguments.length>u;u)this[e++]=t(this._constructor,arguments[u++]);return this.length=h,this},slice:function(){return d.apply(this,arguments)},sort:function(t){return m.call(this,t),this},reverse:function(){for(var t=d.call(this,0),n=0,r=this.length;r>n;n++)this[n]=t[r-n-1];return this},toString:function(){return""+d.call(this,0)},each:function(t,n){for(var r=0,e=this.length;e>r;r++)t.call(n||this,this[r],r);return this},where:function(t){for(var r,e=new this.constructor,i=0,u=this.length;u>i;i++)r=this[i],n(r,t)&&(e[e.length++]=r);return e},remove:function(t){for(var r=-1,e=[],i=0,u=this.length;u>i;i++)n(this[i],t)?e.push(this[i]):this[++r]=this[i];for(i=++r;u>i;i++)this[i]=null;return this.length=r,e},first:function(t){if(null==t)return this[0];var n=this.indexOf(t);return-1!==n?this[n]:null},last:function(t){if(null==t)return this[this.length-1];var n=this.lastIndexOf(t);return-1!==n?this[n]:null},indexOf:function(t,r){if(null==t)return-1;if(null!=r){if(0>r&&(r=0),r>=this.length)return-1}else r=0;for(var e=this.length;e>r;r++)if(n(this[r],t))return r;return-1},lastIndexOf:function(t,r){if(null==t)return-1;if(null!=r){if(r>=this.length&&(r=this.length-1),0>r)return-1}else r=this.length-1;for(;r>-1;r--)if(n(this[r],t))return r;return-1}};return r}(),u={toArray:function(){for(var t=Array(this.length),n=0,r=this.length;r>n;n++)t[n]=this[n];return t},toJSON:function(){for(var t,n=Array(this.length),e=0,i=this.length;i>e;e++)t=this[e],null!=t&&(n[e]=r(this[e].toJSON)?this[e].toJSON():w.toJSON.call(this[e]));return n}};return e}();var x={fetch:null,save:null,del:null,onSuccess:null,onError:null,Static:{fetch:function(t){return(new this).fetch(t)}}};N.Remote=function(){var t=function(t){this._route=new b(t)};return a(t,x,v,y,{serialize:function(){return e(this)?w.arrayToJSON.call(this):w.toJSON.call(this)},fetch:function(t){return O.get(this._route.create(t||this),this),this},save:function(t){var n=this,r=this.serialize(),e=this._route.create(this),i=this._route.hasAliases(this)?"put":"post";return this._resolved=null,this._rejected=null,O[i](e,r,function(r,e){return t&&t(r,e),r?n.reject(r):(n.resolve(e),void 0)}),this},del:function(t){var n=this,r=this.serialize(),e=this._route.create(this);return this._resolved=null,this._rejected=null,O.del(e,r,function(r,e){return t&&t(r,e),r?n.reject(r):(n.resolve(e),void 0)}),this},onSuccess:function(t){var n;try{n=JSON.parse(t)}catch(r){return this.onError(r),void 0}this.deserialize(n),this.resolve(this)},onError:function(t){this.reject({error:t})}}),function(n){return new t(n)}}(),N.LocalStore=function(){function t(t,n){var r=t.create(n);localStorage.removeItem(r)}var n=function(t){this._route=new b(t)};a(n,x,v,y,{serialize:function(){var t=e(this)?w.arrayToJSON.call(this):w.toJSON.call(this);return JSON.stringify(t)},fetch:function(t){var n=this._route.create(t||this),r=localStorage.getItem(n);if(null==r)return this.resolve(this),this;if(i(r))try{r=JSON.parse(r)}catch(e){this.onError(e)}return this.deserialize(r),this.resolve(this)},save:function(t){var n=this._route.create(this),r=this.serialize();return localStorage.setItem(n,r),t&&t(),this},del:function(n){if(null==n&&0!==arguments.length)return console.error("<localStore:del> - selector is specified, but is undefined"),this;if(o(this)===!1)return t(this._route,n||this),this;if(null==n){for(var r=0,e=this.length;e>r;r++)this[r]=null;return this.length=0,t(this._route,this),this}var i=this.remove(n);return 0===i.length?this:this.save()},onError:function(t){this.reject({error:t})}});var r=function(t){return new n(t)};return r.prototype=n.prototype,r}(),function(){function t(t,n){if(t.length!==n.length)return!1;for(var r=t.length,e=0;r>e;e++)if(t[e]!==n[e])return!1;return!0}function n(n,r){if(0===r.length)return 0;for(var e=0,i=n.length;i>e;e++)if(t(n[e],r))return e+1;return n.push(r),n.length}function r(t){var r={},e=[];return function(){var i=n(e,arguments);return null==r[i]?r[i]=t.apply(this,arguments):r[i]}}function e(t,n,r){return function(){t[r]=arguments;for(var e,i=0,u=n[r].length;u>i;i++)e=n[r][i],e.apply(this,arguments);n[i]=null,t=null,n=null}}function i(t){var r={},i={},u=[];return function(){var o=Array.prototype.slice.call(arguments),s=o.pop(),l=n(u,o);return r[l]?(s.apply(this,r[l]),void 0):i[l]?(i[l].push(s),void 0):(i[l]=[s],o=Array.prototype.slice.call(o),o.push(e(r,i,l)),t.apply(this,o),void 0)}}N.Fn={memoize:r,memoizeAsync:i}}(),n.Class=N});